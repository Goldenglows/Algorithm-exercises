class Solution {
public:
    long long maxPower(vector<int>& stations, int r, int k) {
        int n = stations.size();
        vector<long long> diff(n + 1, 0);  // 差分数组

        // 1. 预处理：每个已有电站的覆盖范围
        for (int i = 0; i < n; ++i) {
            int left = max(0, i - r);
            int right = min(n, i + r + 1);
            diff[left] += stations[i];
            if (right < n) diff[right] -= stations[i];
        }

        // 2. 二分答案
        long long lo = LLONG_MAX, hi = 0;
        long long sum = 0;
        for (int i = 0; i < n; ++i) {
            sum += diff[i];
            lo = min(lo, sum);
            hi += stations[i];
        }
        hi += k;

        long long ans = lo;

        auto check = [&](long long mid) -> bool {
            vector<long long> d = diff;  // 复制差分数组
            long long cur = 0;           // 当前城市电量
            long long need = 0;          // 总共需要的新电站

            for (int i = 0; i < n; ++i) {
                cur += d[i];
                if (cur < mid) {
                    long long add = mid - cur;
                    need += add;
                    if (need > k) return false;

                    // 在城市 i 建 add 个电站，影响 [i, i+2*r]
                    d[i] += add;
                    int end = min(n, i + 2 * r + 1);
                    if (end < n) d[end] -= add;
                    cur += add;
                }
            }
            return true;
        };

        while (lo <= hi) {
            long long mid = lo + (hi - lo) / 2;
            if (check(mid)) {
                ans = mid;
                lo = mid + 1;
            } else {
                hi = mid - 1;
            }
        }

        return ans;
    }
};
